<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vue CRUD with REST API</title>
  <script src="node_modules/vue/dist/vue.global.js"></script>
  <script src="node_modules/axios/dist/axios.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      background-color: rgb(230, 230, 230);
    }

    input,
    button {
      margin: 0.5rem;
      padding: 0.5rem;
    }

    .user {
      display: flex;
      justify-content: space-between;
      margin: 0.5rem 0;
    }

    button {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="app" style="user-select: none;">

    <div v-if="!token">
      <h3>Login</h3>
      <input v-model="loginForm.username" placeholder="Username" />
      <input v-model="loginForm.password" type="password" placeholder="Password" />
      <button @click="login">Login</button>
    </div>

    <div v-else style="padding: 40px; background-color: white; border-radius: 20px;">

      <!--VEHICLES-->

      <div style="display: flex; justify-content: space-between;">
        <h1 style="display: inline;">Vehicle</h1>
        <button @click="logout">Logout</button>
      </div>
      <hr>


      <h3>Vehicles</h3>
      <div v-for="vehicle in vehicles" :key="vehicle.id" class="vehicle"
        style="display: flex; justify-content: space-between;">
        <div>
          <input v-model="vehicle.name" />
          <input v-model="vehicle.avg_consumption" />
        </div>

        <div style="display: inline;">
          <button @click="updateVehicle(vehicle)">Update</button>
          <button @click="deleteVehicle(vehicle.id)">Delete</button>
        </div>
      </div>
      <br>

      <h3>Add Vehicle</h3>
      <div style="display: flex; justify-content: space-between;">
        <div>
          <input v-model="newVehicleName" required placeholder="Vehicle" />
          <input v-model="newVehicleConsumption" placeholder="Consumption" type="number" step="0.1" min="0"/>
        </div>

        <button @click="createVehicle">Add</button>
      </div>
      <br>

      <!--EMPLOYEES-->
      <h1>Employee</h1>
      <hr>

      <h3>Employees</h3>
      <div v-for="employee in employees" :key="employee.id" class="employee"
        style="display: flex; justify-content: space-between;">
        <div>
          <input v-model="employee.name" />
          <input v-model="employee.surname" />
          <input v-model="employee.position" />
          <input v-model="employee.card_id_num" />
          <input v-model="employee.ssn" />
        </div>

        <div style="display: inline;">
          <button @click="updateEmployee(employee)">Update</button>
          <button @click="deleteEmployee(employee.id)">Delete</button>
        </div>
      </div>
      <br>

      <h3>Add Employee</h3>
      <div style="display: flex; justify-content: space-between;">
        <div>
          <input v-model="newEmployeeName" required placeholder="Name" />
          <input v-model="newEmployeeSurname" required placeholder="Surname" />
          <input v-model="newEmployeePosition" required placeholder="Position" />
          <input v-model="newEmployeeCardNum" required placeholder="Card ID Number" />
          <input v-model="newEmployeeSSN" required placeholder="Social Security Number" />
        </div>

        <button @click="createEmployee">Add</button>
      </div>
      <br>

      <!-- ORAGNISATIONS -->
      <h1>Organisation</h1>
      <hr>

      <h3>Organisations</h3>
      <div v-for="organisation in organisations" :key="organisation.id" class="oragnisation"
        style="display: flex; justify-content: space-between;">
        <div>
          <input v-model="organisation.resp_person" />
          <input v-model="organisation.seal" />
          <input v-model="organisation.name" />
          <input v-model="organisation.address" />
          <input v-model="organisation.issuer" />
        </div>

        <div style="display: inline;">
          <button @click="updateOrganisation(organisation)">Update</button>
          <button @click="deleteOrganisation(organisation.id)">Delete</button>
        </div>
      </div>
      <br>

      <h3>Add Organisation</h3>
      <div style="display: flex; justify-content: space-between;">
        <div>
          <input v-model="newOrganisationRespPerson" required placeholder="Responsible person" />
          <input v-model="newOrganisationSeal" required placeholder="Seal" />
          <input v-model="newOrganisationName" required placeholder="Name" />
          <input v-model="newOrganisationAddress" required placeholder="Address" />
          <input v-model="newOrganisationIssuer" required placeholder="Issuer" />
        </div>

        <button @click="createOrganisation">Add</button>
      </div>
      <br>

      <!-- TRAVEL ORDERS -->
      <h1>Travel Order</h1>
      <hr>

      <h3>Travel Orders</h3>
      <div v-for="travel_order in travel_orders" :key="travel_order.id" class="travel_order"
        style="display: flex; justify-content: space-between;">
        <div>
          <input type="datetime" v-model="travel_order.start_date" />
          <input type="datetime" v-model="travel_order.end_date" />
          <input v-model="travel_order.task" />
          <input v-model="travel_order.location" />
          <input v-model="travel_order.per_diem" />
          <input v-model="travel_order.report" />
          <input v-model="travel_order.state" />
          <input v-model="travel_order.adv_payment" />
          
          <select v-model="travel_order.fk_vehicle">
            <option v-for="vehicle in vehicles" :key="vehicle.id" :value="vehicle.id">
              {{ vehicle.name }}
            </option>
          </select>

          <select v-model="travel_order.fk_organisation">
            <option v-for="organisation in organisations" :key="organisation.id" :value="organisation.id">
              {{ organisation.name }}
            </option>
          </select>
        </div>

        <div style="display: inline;">
          <button @click="updateTravelOrder(travel_order)">Update</button>
          <button @click="deleteTravelOrder(travel_order.id)">Delete</button>
        </div>
      </div>
      <br>

      <h3>Add Travel Order</h3>
      <div style="display: flex; justify-content: space-between;">
        <div>
          <input type="date" v-model="newTravelOrderStartDate" required placeholder="Start date" />
          <input type="date" v-model="newTravelOrderEndDate" placeholder="End date" />
          <input v-model="newTravelOrderTask" placeholder="Task" />
          <input v-model="newTravelOrderLocation" required placeholder="Location" />
          <input v-model="newTravelOrderPerDiem" placeholder="Per Diem" type="number" step="0.1" min="0"/>
          <input v-model="newTravelOrderReport" placeholder="Report" />
          <input v-model="newTravelOrderState" required placeholder="State" />
          <input v-model="newTravelOrderAdvPayment" placeholder="Advance payment" type="number" step="0.1" min="0"/>

          <input v-model="newTravelOrderFkVehicle" placeholder="FK Vehicle" hidden/>
          <select v-model="newTravelOrderFkVehicle">
            <option disabled value="">-- Select a vehicle --</option>
            <option v-for="vehicle in vehicles" :key="vehicle.id" :value="vehicle.id">
              {{ vehicle.name }}
            </option>
          </select>

          <input v-model="newTravelOrderFkOrganisation" placeholder="FK Organisation" hidden/>
          <select v-model="newTravelOrderFkOrganisation">
            <option disabled value="">-- Select a organisation --</option>
            <option v-for="organisation in organisations" :key="organisation.id" :value="organisation.id">
              {{ organisation.name }}
            </option>
          </select>
        </div>

        <button @click="createTravelOrder">Add</button>
      </div>
      <br>

      <!-- TRAVEL EXPENCES -->
      <h1>Travel Expence</h1>
      <hr>

      <h3>Travel Expences</h3>
      <div v-for="travel_expence in travel_expences" :key="travel_expence.id" class="travel_expence"
        style="display: flex; justify-content: space-between;">
        <div>
          <input v-model="travel_expence.expence_type" />
          <input v-model="travel_expence.start_location" />
          <input v-model="travel_expence.end_location" />
          <input v-model="travel_expence.distance" />
          <input v-model="travel_expence.receipt" />
          <input v-model="travel_expence.price" />

          <select v-model="travel_expence.fk_travel_order">
            <option v-for="travel_order in travel_orders" :key="travel_order.id" :value="travel_order.id">
              {{ `OD ${travel_order.start_date} DO ${travel_order.end_date}: ${travel_order.location}`}}
            </option>
          </select>
        </div>

        <div style="display: inline;">
          <button @click="updateTravelExpence(travel_expence)">Update</button>
          <button @click="deleteTravelExpence(travel_expence.id)">Delete</button>
        </div>
      </div>
      <br>

      <h3>Add Travel Expence</h3>
      <div style="display: flex; justify-content: space-between;">
        <div>
          <input v-model="newTravelExpenceExpenceType" required placeholder="Expence Type" />
          <input v-model="newTravelExpenceStartLocation" required placeholder="Strart Location" />
          <input v-model="newTravelExpenceEndLocation" required placeholder="End Location" />
          <input v-model="newTravelExpenceDistance" required placeholder="Distance" />
          <input v-model="newTravelExpenceReceipt" required placeholder="Receipt" />
          <input v-model="newTravelExpencePrice" required placeholder="Price" type="number" step="0.1" min="0"/>
          <select v-model="newTravelExpenceFkTravelOrder">
            <option disabled value="">-- Select a Travel Order --</option>
            <option v-for="travel_order in travel_orders" :key="travel_order.id" :value="travel_order.id">
              {{ `OD ${travel_order.start_date} DO ${travel_order.end_date}: ${travel_order.location}`}}
            </option>
          </select>
        </div>

        <button @click="createTravelExpence">Add</button>
      </div>
      <br>

      <!-- ORDER EMPLOYEES -->
      <h1>Order Employee</h1>
      <hr>

      <h3>Order Employees</h3>
      <div v-for="order_employee in order_employees" :key="order_employee.id" class="order_employee"
        style="display: flex; justify-content: space-between;">
        <div>
          <select v-model="order_employee.fk_order">
            <option v-for="travel_order in travel_orders" :key="travel_order.id" :value="travel_order.id">
              {{ `OD ${travel_order.start_date} DO ${travel_order.end_date}: ${travel_order.location}`}}
            </option>
          </select>

          <select v-model="order_employee.fk_employee">
            <option v-for="employee in employees" :key="employee.id" :value="employee.id">
              {{ `${employee.name} ${employee.surname}`}}
            </option>
          </select>
        </div>

        <div style="display: inline;">
          <button @click="deleteOrderEmployee(order_employee.fk_order, order_employee.fk_employee)">Delete</button>
        </div>
      </div>
      <br>

      <h3>Add Order Employee</h3>
      <div style="display: flex; justify-content: space-between;">
        <div>
          <select v-model="newOrderEmployeeFkOrder">
            <option disabled value="">-- Select a Travel Order --</option>
            <option v-for="travel_order in travel_orders" :key="travel_order.id" :value="travel_order.id">
              {{ `OD ${travel_order.start_date} DO ${travel_order.end_date}: ${travel_order.location}`}}
            </option>
          </select>

          <select v-model="newOrderEmployeeFkEmployee">
            <option disabled value="">-- Select an employee --</option>
            <option v-for="employee in employees" :key="employee.id" :value="employee.id">
              {{ `${employee.name} ${employee.surname}` }}
            </option>
          </select>
        </div>

        <button @click="createOrderEmployee">Add</button>
      </div>
      <br>

    </div>

    <script>
      const { createApp, ref } = Vue;

      createApp({
        setup() {
          const apiBase = 'http://localhost:3000'; // or 3000 for Node.js
          const token = ref(localStorage.getItem('token'));

          const vehicles = ref([]);
          const employees = ref([]);
          const organisations = ref([]);
          const travel_orders = ref([]);
          const travel_expences = ref([]);
          const order_employees = ref([]);

          const newVehicleName = ref('');
          const newVehicleConsumption = ref('');

          const newEmployeeName = ref('');
          const newEmployeeSurname = ref('');
          const newEmployeePosition = ref('');
          const newEmployeeCardNum = ref('');
          const newEmployeeSSN = ref('');

          const newOrganisationRespPerson = ref('');
          const newOrganisationSeal = ref('');
          const newOrganisationName = ref('');
          const newOrganisationAddress = ref('');
          const newOrganisationIssuer = ref('');

          const newTravelOrderStartDate = ref('');
          const newTravelOrderEndDate = ref('');
          const newTravelOrderTask = ref('');
          const newTravelOrderLocation = ref('');
          const newTravelOrderPerDiem = ref('');
          const newTravelOrderReport = ref('');
          const newTravelOrderState = ref('');
          const newTravelOrderAdvPayment = ref('');
          const newTravelOrderFkVehicle = ref('');
          const newTravelOrderFkOrganisation = ref('');

          const newTravelExpenceExpenceType = ref('');
          const newTravelExpenceStartLocation = ref('');
          const newTravelExpenceEndLocation = ref('');
          const newTravelExpenceDistance = ref('');
          const newTravelExpenceReceipt = ref('');
          const newTravelExpencePrice = ref('');
          const newTravelExpenceFkTravelOrder = ref('');

          const newOrderEmployeeFkOrder = ref('');
          const newOrderEmployeeFkEmployee = ref('');


          const loginForm = ref({ username: '', password: '' });

          const authHeaders = () => ({ headers: { Authorization: `Bearer ${token.value}` } });

          const fetchVehicles = async () => {
            const res = await axios.get(`${apiBase}/vehicle`, authHeaders());
            vehicles.value = res.data;
          };

          const fetchEmployees = async () => {
            const res = await axios.get(`${apiBase}/employee`, authHeaders());
            employees.value = res.data;
          };

          const fetchOrganisations = async () => {
            const res = await axios.get(`${apiBase}/organisation`, authHeaders());
            organisations.value = res.data;
          };

          const fetchTravelOrders = async () => {
            const res = await axios.get(`${apiBase}/travel_order`, authHeaders());
            travel_orders.value = res.data;
          };

          const fetchTravelExpences = async () => {
            const res = await axios.get(`${apiBase}/travel_expence`, authHeaders());
            travel_expences.value = res.data;
          };

          const fetchOrderEmployeees = async () => {
            const res = await axios.get(`${apiBase}/order_employee`, authHeaders());
            order_employees.value = res.data;
          };

          const login = async () => {
            try {
              const res = await axios.post(`${apiBase}/login`, loginForm.value);
              token.value = res.data.token;
              localStorage.setItem('token', token.value);
              fetchVehicles();
              fetchEmployees();
              fetchOrganisations();
              fetchTravelOrders();
              fetchTravelExpences();
              fetchOrderEmployeees();
            } catch {
              alert('Login failed');
            }
          };

          const logout = () => {
            token.value = null;
            localStorage.removeItem('token');
            vehicles.value = [];
            employees.value = [];
            organisations.value = [];
            travel_orders.value = [];
            travel_expences.value = [];
            order_employees.value = [];
          };

          const createVehicle = async () => {
            if (!newVehicleName.value || !newVehicleConsumption.value) return;
            await axios.post(`${apiBase}/vehicle`, { name: newVehicleName.value, avgConsumption: newVehicleConsumption.value }, authHeaders());
            newVehicleName.value = '';
            newVehicleConsumption.value = '';
            fetchVehicles();
          };

          const createEmployee = async () => {
            if (!newEmployeeName.value || !newEmployeeSurname.value || !newEmployeePosition.value || !newEmployeeCardNum.value || !newEmployeeSSN.value) return;
            await axios.post(`${apiBase}/employee`, { name: newEmployeeName.value, surname: newEmployeeSurname.value, position: newEmployeePosition.value, cardIdNum: newEmployeeCardNum.value, ssn: newEmployeeSSN.value }, authHeaders());
            newEmployeeName.value = '';
            newEmployeeSurname.value = '';
            newEmployeePosition.value = '';
            newEmployeeCardNum.value = '';
            newEmployeeSSN.value = '';
            fetchEmployees();
          };

          const createOrganisation = async () => {
            if (!newOrganisationRespPerson.value || !newOrganisationSeal.value || !newOrganisationName.value || !newOrganisationAddress.value || !newOrganisationIssuer.value) return;
            await axios.post(`${apiBase}/organisation`, { respPerson: newOrganisationRespPerson.value, seal: newOrganisationSeal.value, name: newOrganisationName.value, address: newOrganisationAddress.value, issuer: newOrganisationIssuer.value }, authHeaders());
            newOrganisationRespPerson.value = '';
            newOrganisationSeal.value = '';
            newOrganisationName.value = '';
            newOrganisationAddress.value = '';
            newOrganisationIssuer.value = '';
            fetchOrganisations();
          };

          const createTravelOrder = async () => {
            if (!newTravelOrderStartDate.value || !newTravelOrderEndDate.value || !newTravelOrderTask.value || !newTravelOrderLocation.value || !newTravelOrderPerDiem.value || !newTravelOrderReport.value || !newTravelOrderState.value || !newTravelOrderAdvPayment.value || !newTravelOrderFkVehicle.value || !newTravelOrderFkOrganisation.value) return;
            const res = await axios.post(`${apiBase}/travel_order`, { startDate: newTravelOrderStartDate.value, endDate: newTravelOrderEndDate.value, task: newTravelOrderTask.value, location: newTravelOrderLocation.value, perDiem: newTravelOrderPerDiem.value, report: newTravelOrderReport.value, state: newTravelOrderState.value, advPayment: newTravelOrderAdvPayment.value, fkVehicle: newTravelOrderFkVehicle.value, fkOrganisation: newTravelOrderFkOrganisation.value }, authHeaders());
            newTravelOrderStartDate.value = '';
            newTravelOrderEndDate.value = '';
            newTravelOrderTask.value = '';
            newTravelOrderLocation.value = '';
            newTravelOrderPerDiem.value = '';
            newTravelOrderReport.value = '';
            newTravelOrderState.value = '';
            newTravelOrderAdvPayment.value = '';
            newTravelOrderFkVehicle.value = '';
            newTravelOrderFkOrganisation.value = '';
            alert(res.data.message);
            fetchTravelOrders();
          };

          const createTravelExpence = async () => {
            if (!newTravelExpenceExpenceType.value || !newTravelExpenceStartLocation.value || !newTravelExpenceEndLocation.value || !newTravelExpenceDistance.value || !newTravelExpenceReceipt.value || !newTravelExpencePrice.value || !newTravelExpenceFkTravelOrder) return;
            await axios.post(`${apiBase}/travel_expence`, { expenceType: newTravelExpenceExpenceType.value, startLocation: newTravelExpenceStartLocation.value, endLocation: newTravelExpenceEndLocation.value, distance: newTravelExpenceDistance.value, receipt: newTravelExpenceReceipt.value, price: newTravelExpencePrice.value, fkTravelOrder: newTravelExpenceFkTravelOrder.value }, authHeaders());
            newTravelExpenceExpenceType.value = '';
            newTravelExpenceStartLocation.value = '';
            newTravelExpenceEndLocation.value = '';
            newTravelExpenceDistance.value = '';
            newTravelExpenceReceipt.value = '';
            newTravelExpencePrice.value = '';
            newTravelExpenceFkTravelOrder.value = '';
            fetchTravelExpences();
          };

          const createOrderEmployee = async () => {
            if (!newOrderEmployeeFkOrder.value || !newOrderEmployeeFkEmployee.value) return;
            const res = await axios.post(`${apiBase}/order_employee`, { fkOrder: newOrderEmployeeFkOrder.value, fkEmployee: newOrderEmployeeFkEmployee.value }, authHeaders());
            newOrderEmployeeFkOrder.value = '';
            newOrderEmployeeFkEmployee.value = '';
            alert(res.data.message);
            fetchOrderEmployeees();
          };

          const updateVehicle = async (vehicle) => {
            await axios.put(`${apiBase}/vehicle/${vehicle.id}`, { name: vehicle.name, avgConsumption: vehicle.avg_consumption }, authHeaders());
            fetchVehicles();
          };

          const updateEmployee = async (employee) => {
            await axios.put(`${apiBase}/employee/${employee.id}`, { name: employee.name, surname: employee.surname, position: employee.position, cardIdNum: employee.card_id_num, ssn: employee.ssn }, authHeaders());
            fetchEmployees();
          };

          const updateOrganisation = async (organisation) => {
            await axios.put(`${apiBase}/organisation/${organisation.id}`, { respPerson: organisation.resp_person, seal: organisation.seal, name: organisation.name, address: organisation.address, issuer: organisation.issuer }, authHeaders());
            fetchOrganisations();
          };

          const updateTravelOrder = async (travel_order) => {
            await axios.put(`${apiBase}/travel_order/${travel_order.id}`, { startDate: travel_order.start_date, endDate: travel_order.end_date, task: travel_order.task, location: travel_order.location, perDiem: travel_order.per_diem, report: travel_order.report, state: travel_order.state, advPayment: travel_order.adv_payment, fkVehicle: travel_order.fk_vehicle, fkOrganisation: travel_order.fk_organisation }, authHeaders());
            fetchTravelOrders();
          };

          const updateTravelExpence = async (travel_expence) => {
            await axios.put(`${apiBase}/travel_expence/${travel_expence.id}`, { expenceType: travel_expence.expence_type, startLocation: travel_expence.start_location, endLocation: travel_expence.end_location, distance: travel_expence.distance, receipt: travel_expence.receipt, price: travel_expence.price, fkTravelOrder: travel_expence.fk_travel_order }, authHeaders());
            fetchTravelExpences();
          };

          const deleteVehicle = async (id) => {
            const res = await axios.delete(`${apiBase}/vehicle/${id}`, authHeaders());
            alert(res.data.message);
            fetchVehicles();
          };

          const deleteEmployee = async (id) => {
            const res = await axios.delete(`${apiBase}/employee/${id}`, authHeaders());
            alert(res.data.message);
            fetchEmployees();
          };

          const deleteOrganisation = async (id) => {
            const res = await axios.delete(`${apiBase}/organisation/${id}`, authHeaders());
            alert(res.data.message);
            fetchOrganisations();
          };

          const deleteTravelOrder = async (id) => {
            const res = await axios.delete(`${apiBase}/travel_order/${id}`, authHeaders());
            alert(res.data.message);
            fetchTravelOrders();
          };

          const deleteTravelExpence = async (id) => {
            const res = await axios.delete(`${apiBase}/travel_expence/${id}`, authHeaders());
            alert(res.data.message);
            fetchTravelExpences();
          };

          const deleteOrderEmployee = async (fk_order, fk_employee) => {
            const res = await axios.delete(`${apiBase}/order_employee/${fk_order}/${fk_employee}`, authHeaders());
            console.log(`${apiBase}/order_employee/${fk_order}/${fk_employee}`);
            alert(res.data.message);
            fetchOrderEmployeees();
          };

          if (token.value) {
            fetchVehicles();
            fetchEmployees();
            fetchOrganisations();
            fetchTravelOrders();
            fetchTravelExpences();
            fetchOrderEmployeees();
          }

          return {
            token, vehicles, employees, organisations, travel_orders, travel_expences, order_employees,
            newVehicleName, newVehicleConsumption,
            newEmployeeName, newEmployeeSurname, newEmployeePosition, newEmployeeCardNum, newEmployeeSSN,
            newOrganisationRespPerson, newOrganisationSeal, newOrganisationName, newOrganisationAddress, newOrganisationIssuer,
            newTravelOrderStartDate, newTravelOrderEndDate, newTravelOrderTask, newTravelOrderLocation, newTravelOrderPerDiem, newTravelOrderReport, newTravelOrderState, newTravelOrderAdvPayment, newTravelOrderFkVehicle, newTravelOrderFkOrganisation,
            newTravelExpenceExpenceType, newTravelExpenceStartLocation, newTravelExpenceEndLocation, newTravelExpenceDistance, newTravelExpenceReceipt, newTravelExpencePrice, newTravelExpenceFkTravelOrder,
            newOrderEmployeeFkOrder, newOrderEmployeeFkEmployee,
            loginForm, login, logout,
            createVehicle, createEmployee, createOrganisation, createTravelOrder, createTravelExpence, createOrderEmployee,
            updateVehicle, updateEmployee, updateOrganisation, updateTravelOrder, updateTravelExpence,
            deleteVehicle, deleteEmployee, deleteOrganisation, deleteTravelOrder, deleteTravelExpence, deleteOrderEmployee
          };
        }
      }).mount('#app');
    </script>
</body>

</html>