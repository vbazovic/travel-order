<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vue CRUD with REST API</title>
  <script src="node_modules/vue/dist/vue.global.js"></script>
  <script src="node_modules/axios/dist/axios.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; background-color: rgb(230, 230, 230);}
    input, button { margin: 0.5rem; padding: 0.5rem; }
    .user { display: flex; justify-content: space-between; margin: 0.5rem 0; }
    button{cursor: pointer;}
  </style>
</head>
<body>
<div id="app" style="user-select: none;">
  
  <div v-if="!token">
    <h3>Login</h3>
    <input v-model="loginForm.username" placeholder="Username" />
    <input v-model="loginForm.password" type="password" placeholder="Password" />
    <button @click="login">Login</button>
  </div>

  <div v-else style="padding: 40px; background-color: white; border-radius: 20px;">

    <!--VEHICLES-->

    <div style="display: flex; justify-content: space-between;">
      <h1 style="display: inline;">Vehicle</h1>
      <button @click="logout">Logout</button>
    </div>
    <hr>

    
    <h3>Vehicles</h3>    
      <div v-for="vehicle in vehicles" :key="vehicle.id" class="vehicle" style="display: flex; justify-content: space-between;">
        <div>
          <input v-model="vehicle.name" />
          <input v-model="vehicle.avg_consumption" />
        </div>
        
        <div style="display: inline;">
          <button @click="updateVehicle(vehicle)">Update</button>
          <button @click="deleteVehicle(vehicle.id)">Delete</button>
        </div>
      </div>
    <br>

    <h3>Add Vehicle</h3>
    <div style="display: flex; justify-content: space-between;">
      <div>
        <input v-model="newVehicleName" placeholder="Vehicle" />
        <input v-model="newVehicleConsumption" placeholder="Consumption" />
      </div>
      
      <button @click="createVehicle">Add</button>
    </div>
    <br>

    <!--EMPLOYEES-->
    <h1>Employees</h1>
    <hr>

    <h3>Employees</h3>    
      <div v-for="employee in employees" :key="employee.id" class="employee" style="display: flex; justify-content: space-between;">
        <div>
          <input v-model="employee.name" />
          <input v-model="employee.surname" />
          <input v-model="employee.position" />
          <input v-model="employee.card_id_num" />
          <input v-model="employee.ssn" />
        </div>
        
        <div style="display: inline;">
          <button @click="updateEmployee(employee)">Update</button>
          <button @click="deleteEmployee(employee.id)">Delete</button>
        </div>
      </div>
    <br>

    <h3>Add Employee</h3>
    <div style="display: flex; justify-content: space-between;">
      <div>
        <input v-model="newEmployeeName" placeholder="Name" />
        <input v-model="newEmployeeSurname" placeholder="Surname" />
        <input v-model="newEmployeePosition" placeholder="Position" />
        <input v-model="newEmployeeCardNum" placeholder="Card ID Number" />
        <input v-model="newEmployeeSSN" placeholder="Social Security Number" />
      </div>

      <button @click="createEmployee">Add</button>
    </div>
  <br>
  
  <!-- ORAGNISATIONS -->
   <h1>Organisations</h1>
    <hr>

    <h3>Organisations</h3>    
      <div v-for="organisation in organisations" :key="organisation.id" class="oragnisation" style="display: flex; justify-content: space-between;">
        <div>
          <input v-model="organisation.resp_person" />
          <input v-model="organisation.seal" />
          <input v-model="organisation.name" />
          <input v-model="organisation.address" />
          <input v-model="organisation.issuer" />
        </div>
        
        <div style="display: inline;">
          <button @click="updateOrganisation(organisation)">Update</button>
          <button @click="deleteOrganisation(organisation.id)">Delete</button>
        </div>
      </div>
    <br>

    <h3>Add Organisation</h3>
    <div style="display: flex; justify-content: space-between;">
      <div>
        <input v-model="newOrganisationRespPerson" placeholder="Responsible person" />
        <input v-model="newOrganisationSeal" placeholder="Seal" />
        <input v-model="newOrganisationName" placeholder="Name" />
        <input v-model="newOrganisationAddress" placeholder="Address" />
        <input v-model="newOrganisationIssuer" placeholder="Issuer" />
      </div>

      <button @click="createOrganisation">Add</button>
    </div>
  <br>

</div>

<script>
const { createApp, ref } = Vue;

createApp({
  setup() {
    const apiBase = 'http://localhost:3000'; // or 3000 for Node.js
    const token = ref(localStorage.getItem('token'));

    const vehicles = ref([]);
    const employees = ref([]);
    const organisations = ref([]);

    const newVehicleName = ref('');
    const newVehicleConsumption = ref('');

    const newEmployeeName = ref('');
    const newEmployeeSurname = ref('');
    const newEmployeePosition = ref('');
    const newEmployeeCardNum = ref('');
    const newEmployeeSSN = ref('');

    const newOrganisationRespPerson = ref('');
    const newOrganisationSeal = ref('');
    const newOrganisationName = ref('');
    const newOrganisationAddress = ref('');
    const newOrganisationIssuer = ref('');

    const loginForm = ref({ username: '', password: '' });

    const authHeaders = () => ({ headers: { Authorization: `Bearer ${token.value}` } });

    const fetchVehicles = async () => {
      const res = await axios.get(`${apiBase}/vehicle`, authHeaders());
      vehicles.value = res.data;
    };

    const fetchEmployees = async () => {
      const res = await axios.get(`${apiBase}/employee`, authHeaders());
      employees.value = res.data;
    };

    const fetchOrganisations = async () => {
      const res = await axios.get(`${apiBase}/organisation`, authHeaders());
      organisations.value = res.data;
    };

    const login = async () => {
      try {
        const res = await axios.post(`${apiBase}/login`, loginForm.value);
        token.value = res.data.token;
        localStorage.setItem('token', token.value);
        fetchVehicles();
        fetchEmployees();
        fetchOrganisations();
      } catch {
        alert('Login failed');
      }
    };

    const logout = () => {
      token.value = null;
      localStorage.removeItem('token');
      vehicles.value = [];
      employees.value = [];
      organisations.value = [];
    };

    const createVehicle = async () => {
      if (!newVehicleName.value || !newVehicleConsumption.value) return;
      await axios.post(`${apiBase}/vehicle`, { name: newVehicleName.value, avgConsumption:newVehicleConsumption.value}, authHeaders());
      newVehicleName.value = '';
      newVehicleConsumption.value = '';
      fetchVehicles();
    };

    const createEmployee = async () => {
      if (!newEmployeeName.value || !newEmployeeSurname.value || !newEmployeePosition.value || !newEmployeeCardNum.value || !newEmployeeSSN.value) return;
      await axios.post(`${apiBase}/employee`, { name: newEmployeeName.value, surname: newEmployeeSurname.value, position: newEmployeePosition.value, cardIdNum: newEmployeeCardNum.value, ssn: newEmployeeSSN.value}, authHeaders());
      newEmployeeName.value = '';
      newEmployeeSurname.value = '';
      newEmployeePosition.value = '';
      newEmployeeCardNum.value = '';
      newEmployeeSSN.value = '';
      fetchEmployees();
    };

    const createOrganisation = async () => {
      if (!newOrganisationRespPerson.value || !newOrganisationSeal.value || !newOrganisationName.value || !newOrganisationAddress.value || !newOrganisationIssuer.value) return;
      await axios.post(`${apiBase}/organisation`, { respPerson: newOrganisationRespPerson.value, seal: newOrganisationSeal.value, name: newOrganisationName.value, address: newOrganisationAddress.value, issuer: newOrganisationIssuer.value}, authHeaders());
      newOrganisationRespPerson.value = '';
      newOrganisationSeal.value = '';
      newOrganisationName.value = '';
      newOrganisationAddress.value = '';
      newOrganisationIssuer.value = '';
      fetchOrganisations();
    };

    const updateVehicle = async (vehicle) => {
      await axios.put(`${apiBase}/vehicle/${vehicle.id}`, { name: vehicle.name, avgConsumption: vehicle.avg_consumption }, authHeaders());
      fetchVehicles();
    };

    const updateEmployee = async (employee) => {
      await axios.put(`${apiBase}/employee/${employee.id}`, { name: employee.name, surname: employee.surname, position: employee.position, cardIdNum: employee.card_id_num, ssn: employee.ssn }, authHeaders());
      fetchEmployees();
    };

    const updateOrganisation = async (organisation) => {
      await axios.put(`${apiBase}/organisation/${organisation.id}`, { respPerson: organisation.resp_person, seal: organisation.seal, name: organisation.name, address: organisation.address, issuer: organisation.issuer }, authHeaders());
      fetchOrganisations();
    };

    const deleteVehicle = async (id) => {
      const res = await axios.delete(`${apiBase}/vehicle/${id}`, authHeaders());
      alert(res.data.message);
      fetchVehicles();
    };

    const deleteEmployee = async (id) => {
      const res = await axios.delete(`${apiBase}/employee/${id}`, authHeaders());
      alert(res.data.message);
      fetchEmployees();
    };

    const deleteOrganisation = async (id) => {
      const res = await axios.delete(`${apiBase}/organisation/${id}`, authHeaders());
      alert(res.data.message);
      fetchOrganisations();
    };

    if (token.value){
      fetchVehicles();
      fetchEmployees();
      fetchOrganisations();
    }

    return { token, vehicles, employees, organisations, newVehicleName, newVehicleConsumption, newEmployeeName, newEmployeeSurname, newEmployeePosition, newEmployeeCardNum, newEmployeeSSN, newOrganisationRespPerson, newOrganisationSeal, newOrganisationName, newOrganisationAddress, newOrganisationIssuer, loginForm, login, logout, createVehicle, createEmployee, createOrganisation, updateVehicle, updateEmployee, updateOrganisation, deleteVehicle, deleteEmployee, deleteOrganisation };
  }
}).mount('#app');
</script>
</body>
</html>
